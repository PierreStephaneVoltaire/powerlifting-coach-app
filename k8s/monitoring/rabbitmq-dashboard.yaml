apiVersion: v1
kind: ConfigMap
metadata:
  name: rabbitmq-dashboard
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
data:
  rabbitmq-dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "RabbitMQ & Message Processing",
        "tags": ["rabbitmq", "messaging", "queues"],
        "style": "dark",
        "timezone": "browser",
        "editable": true,
        "hideControls": false,
        "refresh": "10s",
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "panels": [
          {
            "id": 1,
            "title": "Message Processing Rate (by service)",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
            "targets": [
              {
                "expr": "rate(rabbitmq_messages_processed_total[5m])",
                "legendFormat": "{{service}} - {{queue}}"
              }
            ],
            "yaxes": [
              {"format": "ops", "label": "messages/sec"},
              {"format": "short"}
            ]
          },
          {
            "id": 2,
            "title": "Message Failure Rate",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
            "targets": [
              {
                "expr": "rate(rabbitmq_messages_failed_total[5m])",
                "legendFormat": "{{service}} - {{queue}} (retry: {{retry_count}})"
              }
            ],
            "yaxes": [
              {"format": "ops", "label": "failures/sec"},
              {"format": "short"}
            ],
            "alert": {
              "conditions": [
                {
                  "evaluator": {"params": [0.1], "type": "gt"},
                  "query": {"params": ["A", "5m", "now"]},
                  "reducer": {"type": "avg"},
                  "type": "query"
                }
              ],
              "frequency": "60s",
              "name": "High Message Failure Rate"
            }
          },
          {
            "id": 3,
            "title": "Dead Letter Queue (DLQ) Growth",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
            "targets": [
              {
                "expr": "rate(rabbitmq_messages_dlq_total[5m])",
                "legendFormat": "{{service}} - {{queue}}"
              }
            ],
            "yaxes": [
              {"format": "ops", "label": "messages to DLQ/sec"},
              {"format": "short"}
            ],
            "alert": {
              "conditions": [
                {
                  "evaluator": {"params": [0], "type": "gt"},
                  "query": {"params": ["A", "5m", "now"]},
                  "reducer": {"type": "avg"},
                  "type": "query"
                }
              ],
              "frequency": "60s",
              "name": "Messages Being Sent to DLQ"
            }
          },
          {
            "id": 4,
            "title": "Message Processing Duration (p95)",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8},
            "targets": [
              {
                "expr": "histogram_quantile(0.95, rate(rabbitmq_message_processing_duration_seconds_bucket[5m]))",
                "legendFormat": "{{service}} - {{queue}} ({{status}})"
              }
            ],
            "yaxes": [
              {"format": "s", "label": "duration"},
              {"format": "short"}
            ]
          },
          {
            "id": 5,
            "title": "Retry Distribution",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16},
            "targets": [
              {
                "expr": "rate(rabbitmq_message_retries_total[5m])",
                "legendFormat": "{{service}} - {{queue}} - Retry {{retry_count}}"
              }
            ],
            "yaxes": [
              {"format": "ops", "label": "retries/sec"},
              {"format": "short"}
            ]
          },
          {
            "id": 6,
            "title": "Active Consumers",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 12, "y": 16},
            "targets": [
              {
                "expr": "rabbitmq_active_consumers",
                "legendFormat": "{{service}} - {{queue}}"
              }
            ]
          },
          {
            "id": 7,
            "title": "RabbitMQ Queue Depth",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 24},
            "targets": [
              {
                "expr": "rabbitmq_queue_messages_ready",
                "legendFormat": "{{queue}} - ready"
              },
              {
                "expr": "rabbitmq_queue_messages_unacknowledged",
                "legendFormat": "{{queue}} - unacked"
              }
            ],
            "yaxes": [
              {"format": "short", "label": "messages"},
              {"format": "short"}
            ],
            "alert": {
              "conditions": [
                {
                  "evaluator": {"params": [1000], "type": "gt"},
                  "query": {"params": ["A", "5m", "now"]},
                  "reducer": {"type": "avg"},
                  "type": "query"
                }
              ],
              "frequency": "60s",
              "name": "High Queue Depth"
            }
          },
          {
            "id": 8,
            "title": "RabbitMQ Connection Count",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 12, "y": 20},
            "targets": [
              {
                "expr": "rabbitmq_connections",
                "legendFormat": "Connections"
              }
            ]
          },
          {
            "id": 9,
            "title": "RabbitMQ Channel Count",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 18, "y": 20},
            "targets": [
              {
                "expr": "rabbitmq_channels",
                "legendFormat": "Channels"
              }
            ]
          },
          {
            "id": 10,
            "title": "Message Publish Rate",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 24},
            "targets": [
              {
                "expr": "rate(rabbitmq_messages_published_total[5m])",
                "legendFormat": "{{service}} - {{exchange}}/{{routing_key}}"
              }
            ],
            "yaxes": [
              {"format": "ops", "label": "messages/sec"},
              {"format": "short"}
            ]
          },
          {
            "id": 11,
            "title": "Publish Errors",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 32},
            "targets": [
              {
                "expr": "rate(rabbitmq_publish_errors_total[5m])",
                "legendFormat": "{{service}} - {{exchange}}/{{routing_key}}"
              }
            ],
            "yaxes": [
              {"format": "ops", "label": "errors/sec"},
              {"format": "short"}
            ]
          },
          {
            "id": 12,
            "title": "RabbitMQ Memory Usage",
            "type": "graph",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 32},
            "targets": [
              {
                "expr": "rabbitmq_resident_memory_limit_bytes",
                "legendFormat": "Memory Limit"
              },
              {
                "expr": "rabbitmq_process_resident_memory_bytes",
                "legendFormat": "Memory Used"
              }
            ],
            "yaxes": [
              {"format": "bytes", "label": "memory"},
              {"format": "short"}
            ]
          },
          {
            "id": 13,
            "title": "Message Success Rate %",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 18, "y": 16},
            "targets": [
              {
                "expr": "100 * (sum(rate(rabbitmq_messages_processed_total[5m])) / (sum(rate(rabbitmq_messages_processed_total[5m])) + sum(rate(rabbitmq_messages_failed_total[5m]))))",
                "legendFormat": "Success Rate"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "percent",
                "thresholds": {
                  "steps": [
                    {"value": 0, "color": "red"},
                    {"value": 95, "color": "yellow"},
                    {"value": 99, "color": "green"}
                  ]
                }
              }
            }
          }
        ],
        "templating": {
          "list": [
            {
              "name": "service",
              "type": "query",
              "query": "label_values(rabbitmq_messages_consumed_total, service)",
              "multi": true,
              "includeAll": true
            },
            {
              "name": "queue",
              "type": "query",
              "query": "label_values(rabbitmq_messages_consumed_total{service=~\"$service\"}, queue)",
              "multi": true,
              "includeAll": true
            }
          ]
        },
        "annotations": {
          "list": [
            {
              "name": "Deployments",
              "datasource": "Prometheus",
              "expr": "changes(kube_deployment_status_replicas_updated[5m]) > 0",
              "titleFormat": "Deployment: {{deployment}}",
              "tagKeys": "deployment,namespace"
            }
          ]
        }
      }
    }
