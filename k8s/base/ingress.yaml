apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: app-tls
  namespace: nginx-gateway
spec:
  secretName: app-tls
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  dnsNames:
    - app.nolift.training
    - api.nolift.training
    - auth.nolift.training
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: frontend-route
  namespace: app
spec:
  parentRefs:
    - name: nginx-gateway
      namespace: nginx-gateway
      sectionName: https
  hostnames:
    - app.nolift.training
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: frontend
          port: 80
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: frontend-http-redirect
  namespace: app
spec:
  parentRefs:
    - name: nginx-gateway
      namespace: nginx-gateway
      sectionName: http
  hostnames:
    - app.nolift.training
  rules:
    - filters:
        - type: RequestRedirect
          requestRedirect:
            scheme: https
            statusCode: 301
      backendRefs:
        - name: frontend
          port: 80
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: api-route
  namespace: app
spec:
  parentRefs:
    - name: nginx-gateway
      namespace: nginx-gateway
      sectionName: https
  hostnames:
    - api.nolift.training
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /api/v1/auth
      backendRefs:
        - name: auth-service
          port: 8080
    - matches:
        - path:
            type: PathPrefix
            value: /api/v1/users
      backendRefs:
        - name: user-service
          port: 8081
    - matches:
        - path:
            type: PathPrefix
            value: /api/v1/videos
      backendRefs:
        - name: video-service
          port: 8082
    - matches:
        - path:
            type: PathPrefix
            value: /api/v1/settings
      backendRefs:
        - name: settings-service
          port: 8083
    - matches:
        - path:
            type: PathPrefix
            value: /api/v1/programs
      backendRefs:
        - name: program-service
          port: 8084
    - matches:
        - path:
            type: PathPrefix
            value: /api/v1/coach
      backendRefs:
        - name: coach-service
          port: 8085
    - matches:
        - path:
            type: PathPrefix
            value: /api/v1/notifications
      backendRefs:
        - name: notification-service
          port: 8086
    - matches:
        - path:
            type: PathPrefix
            value: /api/v1/notify
      backendRefs:
        - name: notification-service
          port: 8086
    - matches:
        - path:
            type: PathPrefix
            value: /api/v1/dm
      backendRefs:
        - name: dm-service
          port: 8084
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: auth-route
  namespace: app
spec:
  parentRefs:
    - name: nginx-gateway
      namespace: nginx-gateway
      sectionName: https
  hostnames:
    - auth.nolift.training
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: keycloak
          port: 8080
