apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: powerlifting-coach-tls
  namespace: nginx-gateway
spec:
  secretName: powerlifting-coach-tls
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  dnsNames:
    - app.powerliftingcoach.app
    - api.powerliftingcoach.app
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: frontend-route
  namespace: app
spec:
  parentRefs:
    - name: nginx-gateway
      namespace: nginx-gateway
      sectionName: https
  hostnames:
    - app.powerliftingcoach.app
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: frontend
          port: 80
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: api-route
  namespace: app
spec:
  parentRefs:
    - name: nginx-gateway
      namespace: nginx-gateway
      sectionName: https
  hostnames:
    - api.powerliftingcoach.app
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /api/v1/auth
      backendRefs:
        - name: auth-service
          port: 8080
    - matches:
        - path:
            type: PathPrefix
            value: /api/v1/users
      backendRefs:
        - name: user-service
          port: 8081
    - matches:
        - path:
            type: PathPrefix
            value: /api/v1/videos
      backendRefs:
        - name: video-service
          port: 8082
    - matches:
        - path:
            type: PathPrefix
            value: /api/v1/settings
      backendRefs:
        - name: settings-service
          port: 8083
    - matches:
        - path:
            type: PathPrefix
            value: /api/v1/programs
      backendRefs:
        - name: program-service
          port: 8084
    - matches:
        - path:
            type: PathPrefix
            value: /api/v1/coach
      backendRefs:
        - name: coach-service
          port: 8085
    - matches:
        - path:
            type: PathPrefix
            value: /api/v1/notifications
      backendRefs:
        - name: notification-service
          port: 8086
    - matches:
        - path:
            type: PathPrefix
            value: /api/v1/notify
      backendRefs:
        - name: notification-service
          port: 8086
    - matches:
        - path:
            type: PathPrefix
            value: /api/v1/dm
      backendRefs:
        - name: dm-service
          port: 8084
---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: admin@powerliftingcoach.app
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
      - http01:
          gatewayHTTPRoute:
            parentRefs:
              - name: nginx-gateway
                namespace: nginx-gateway
                kind: Gateway
