# Infrastructure Setup

This directory contains Terraform configuration for deploying the powerlifting coach application to Azure Kubernetes Service (AKS).

## Prerequisites

- Azure CLI installed and logged in (`az login`)
- Terraform installed (>= 1.0)
- kubectl installed
- A registered domain name (e.g., nolift.training)

## Initial Setup (From Scratch)

There are **3 stages** to deploying the infrastructure:

### Stage 1: Create Base Infrastructure

```bash
cd infrastructure
terraform init

# Create cluster, DNS, storage, email services
terraform apply \
  -var="kubernetes_resources_enabled=false" \
  -var="argocd_resources_enabled=false" \
  -var="email_domain_verified=false"
```

This creates:
- Azure Resource Group
- AKS cluster (default + spot node pools)
- Azure DNS zone
- Storage account for videos
- Azure Communication Services for email
- DNS records (SPF, DKIM, DMARC, email verification TXT)

### Stage 2: Install Kubernetes Components

```bash
# Install nginx-ingress, cert-manager, ArgoCD helm chart, namespaces, secrets
# Note: kubeconfig.yaml already generated by Stage 1
terraform apply \
  -var="kubernetes_resources_enabled=true" \
  -var="argocd_resources_enabled=false" \
  -var="email_domain_verified=false"
```

This installs:
- nginx-ingress controller
- cert-manager for SSL
- ArgoCD (helm chart only, not the Application CRDs yet)
- Namespaces, secrets, configmaps
- Monitoring stack (Prometheus, Grafana, Loki)

**Important**: ArgoCD helm chart must be fully deployed before Stage 3.

### Stage 3: Enable ArgoCD Applications

```bash
# Create ArgoCD Application CRDs (requires ArgoCD to be running)
terraform apply \
  -var="kubernetes_resources_enabled=true" \
  -var="argocd_resources_enabled=true" \
  -var="email_domain_verified=false"
```

Or use the helper script:
```bash
../scripts/enable-argo.sh
```

### After Setup: Configure Domain & Email

**1. Configure nameservers in domain registrar:**
```bash
terraform output azure_nameservers
```

**2. Wait for DNS propagation** (5-60 minutes)

**3. Verify email domain in Azure Portal:**
- Go to Communication Services → Email Services → nolift-dev-email
- Check verification status (Domain, SPF, DKIM, DKIM2)

**4. Once verified, link the domain:**
```bash
terraform apply \
  -var="kubernetes_resources_enabled=true" \
  -var="argocd_resources_enabled=true" \
  -var="email_domain_verified=true"
```

## Alternative: Use Helper Scripts

```bash
# Stages 1 & 2: Initialize infrastructure
../scripts/init-infra.sh

# Stage 3: Enable ArgoCD Applications
../scripts/enable-argo.sh

# Later: After DNS propagation and domain verification in Azure Portal
terraform apply \
  -var='kubernetes_resources_enabled=true' \
  -var='argocd_resources_enabled=true' \
  -var='email_domain_verified=true'
```

## Managing Costs

### Stop Workload (Keep Cluster Running)
```bash
../scripts/stop-workload.sh
# or
terraform apply -var="stopped=true"
```

This:
- Scales spot node pool to 0
- Deletes LoadBalancer (saves IP costs)
- Keeps 1 default node running (nginx-ingress only)

### Start Workload
```bash
../scripts/start-workload.sh
# or
terraform apply -var="stopped=false"
```

### Destroy Everything
```bash
../scripts/destroy-infra.sh
# or
terraform destroy
```

## Configuration Variables

Key variables in `variables.tf`:

- `kubernetes_resources_enabled` - Install K8s resources (namespaces, secrets, ingress)
- `argocd_resources_enabled` - Install ArgoCD applications
- `email_domain_verified` - Link email domain (only after Azure verification)
- `stopped` - Scale down to save costs
- `domain_name` - Your domain (default: "localhost" for local dev)

## Outputs

After applying, get important values:

```bash
# Nameservers for domain registrar
terraform output azure_nameservers

# Cluster name
terraform output cluster_name

# Email SMTP credentials
terraform output azure_email_smtp_username
terraform output -raw azure_email_connection_string
```

## Troubleshooting

### Email domain association fails
- Ensure DNS records are created and propagated
- Verify domain in Azure Portal first
- Only set `email_domain_verified=true` after verification completes

### DNS records not resolving
- Check nameservers are configured in domain registrar
- Wait for DNS propagation (can take up to 48 hours, usually 5-60 min)
- Verify with: `dig @8.8.8.8 nolift.training`

### ArgoCD applications not syncing
- Ensure `argocd_resources_enabled=true`
- Check ArgoCD is fully deployed: `kubectl get pods -n argocd`
- May need to wait a few minutes after enabling
