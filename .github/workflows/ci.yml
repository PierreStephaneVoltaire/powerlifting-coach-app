name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build-all:
        description: 'Build all services and frontend'
        required: false
        type: boolean
        default: false
      services:
        description: 'Comma-separated list of services to build (e.g., auth,user,video). Options: auth, user, video, media-processor, settings, program, coach, notification, dm, machine, reminder, frontend'
        required: false
        type: string
        default: ''

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: "powerlifting-coach"

jobs:
  # Detect which services/components have changed
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      shared: ${{ steps.filter.outputs.shared }}
      auth: ${{ steps.filter.outputs.auth }}
      user: ${{ steps.filter.outputs.user }}
      video: ${{ steps.filter.outputs.video }}
      media-processor: ${{ steps.filter.outputs.media-processor }}
      settings: ${{ steps.filter.outputs.settings }}
      program: ${{ steps.filter.outputs.program }}
      coach: ${{ steps.filter.outputs.coach }}
      notification: ${{ steps.filter.outputs.notification }}
      dm: ${{ steps.filter.outputs.dm }}
      machine: ${{ steps.filter.outputs.machine }}
      reminder: ${{ steps.filter.outputs.reminder }}
      frontend: ${{ steps.filter.outputs.frontend }}
      infrastructure: ${{ steps.filter.outputs.infrastructure }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            shared:
              - 'shared/**'
            auth:
              - 'services/auth-service/**'
              - 'shared/**'
            user:
              - 'services/user-service/**'
              - 'shared/**'
            video:
              - 'services/video-service/**'
              - 'shared/**'
            media-processor:
              - 'services/media-processor-service/**'
              - 'shared/**'
            settings:
              - 'services/settings-service/**'
              - 'shared/**'
            program:
              - 'services/program-service/**'
              - 'shared/**'
            coach:
              - 'services/coach-service/**'
              - 'shared/**'
            notification:
              - 'services/notification-service/**'
              - 'shared/**'
            dm:
              - 'services/dm-service/**'
              - 'shared/**'
            machine:
              - 'services/machine-service/**'
              - 'shared/**'
            reminder:
              - 'services/reminder-service/**'
              - 'shared/**'
            frontend:
              - 'frontend/**'
            infrastructure:
              - 'infrastructure/**'

  # Auto-tag shared folder changes
  tag-shared-version:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.shared == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: get-tag
        run: |
          # Get the latest tag that matches shared/v*.*.* pattern
          LATEST_TAG=$(git tag -l "shared/v*.*.*" | sort -V | tail -1)

          if [ -z "$LATEST_TAG" ]; then
            # No existing tag, start with v1.0.0
            NEW_TAG="shared/v1.0.0"
          else
            # Parse version and bump patch
            VERSION=${LATEST_TAG#shared/v}
            IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
            PATCH=$((PATCH + 1))
            NEW_TAG="shared/v${MAJOR}.${MINOR}.${PATCH}"
          fi

          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "Creating new tag: $NEW_TAG"

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a ${{ steps.get-tag.outputs.new_tag }} -m "Auto-bump shared version to ${{ steps.get-tag.outputs.new_tag }}"
          git push origin ${{ steps.get-tag.outputs.new_tag }}

  # Build auth service
  build-auth-service:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      (needs.detect-changes.outputs.auth == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && (inputs.build-all || contains(inputs.services, 'auth')))
    environment:
      name: prod
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install Podman and QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y podman qemu-user-static

      - name: Setup QEMU for multi-arch builds
        run: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Build and push multi-arch image
        run: |
          IMAGE_PATH="${{ env.REGISTRY }}/pierrestephanevoltaire/${{ env.IMAGE_PREFIX }}/auth-service"
          SHA_TAG="${IMAGE_PATH}:${GITHUB_SHA::8}"
          LATEST_TAG="${IMAGE_PATH}:latest"

          podman manifest create ${SHA_TAG}
          podman manifest create ${LATEST_TAG}

          podman build --platform linux/amd64 --build-arg TARGETARCH=amd64 --manifest ${SHA_TAG} ./services/auth-service
          podman build --platform linux/arm64 --build-arg TARGETARCH=arm64 --manifest ${SHA_TAG} ./services/auth-service

          podman build --platform linux/amd64 --build-arg TARGETARCH=amd64 --manifest ${LATEST_TAG} ./services/auth-service
          podman build --platform linux/arm64 --build-arg TARGETARCH=arm64 --manifest ${LATEST_TAG} ./services/auth-service

          podman manifest push --remove-signatures ${SHA_TAG}
          podman manifest push --remove-signatures ${LATEST_TAG}

  # Build user service
  build-user-service:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      (needs.detect-changes.outputs.user == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && (inputs.build-all || contains(inputs.services, 'user')))
    environment:
      name: prod
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install Podman and QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y podman qemu-user-static

      - name: Setup QEMU for multi-arch builds
        run: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Build and push multi-arch image
        run: |
          IMAGE_PATH="${{ env.REGISTRY }}/pierrestephanevoltaire/${{ env.IMAGE_PREFIX }}/user-service"
          SHA_TAG="${IMAGE_PATH}:${GITHUB_SHA::8}"
          LATEST_TAG="${IMAGE_PATH}:latest"

          podman manifest create ${SHA_TAG}
          podman manifest create ${LATEST_TAG}

          podman build --platform linux/amd64 --build-arg TARGETARCH=amd64 --manifest ${SHA_TAG} ./services/user-service
          podman build --platform linux/arm64 --build-arg TARGETARCH=arm64 --manifest ${SHA_TAG} ./services/user-service

          podman build --platform linux/amd64 --build-arg TARGETARCH=amd64 --manifest ${LATEST_TAG} ./services/user-service
          podman build --platform linux/arm64 --build-arg TARGETARCH=arm64 --manifest ${LATEST_TAG} ./services/user-service

          podman manifest push --remove-signatures ${SHA_TAG}
          podman manifest push --remove-signatures ${LATEST_TAG}

  # Build video service
  build-video-service:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      (needs.detect-changes.outputs.video == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && (inputs.build-all || contains(inputs.services, 'video')))
    environment:
      name: prod
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install Podman and QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y podman qemu-user-static

      - name: Setup QEMU for multi-arch builds
        run: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Build and push multi-arch image
        run: |
          IMAGE_PATH="${{ env.REGISTRY }}/pierrestephanevoltaire/${{ env.IMAGE_PREFIX }}/video-service"
          SHA_TAG="${IMAGE_PATH}:${GITHUB_SHA::8}"
          LATEST_TAG="${IMAGE_PATH}:latest"

          podman manifest create ${SHA_TAG}
          podman manifest create ${LATEST_TAG}

          podman build --platform linux/amd64 --build-arg TARGETARCH=amd64 --manifest ${SHA_TAG} ./services/video-service
          podman build --platform linux/arm64 --build-arg TARGETARCH=arm64 --manifest ${SHA_TAG} ./services/video-service

          podman build --platform linux/amd64 --build-arg TARGETARCH=amd64 --manifest ${LATEST_TAG} ./services/video-service
          podman build --platform linux/arm64 --build-arg TARGETARCH=arm64 --manifest ${LATEST_TAG} ./services/video-service

          podman manifest push --remove-signatures ${SHA_TAG}
          podman manifest push --remove-signatures ${LATEST_TAG}

  # Build media-processor service
  build-media-processor-service:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      (needs.detect-changes.outputs.media-processor == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && (inputs.build-all || contains(inputs.services, 'media-processor')))
    environment:
      name: prod
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install Podman and QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y podman qemu-user-static

      - name: Setup QEMU for multi-arch builds
        run: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Build and push multi-arch image
        run: |
          IMAGE_PATH="${{ env.REGISTRY }}/pierrestephanevoltaire/${{ env.IMAGE_PREFIX }}/media-processor-service"
          SHA_TAG="${IMAGE_PATH}:${GITHUB_SHA::8}"
          LATEST_TAG="${IMAGE_PATH}:latest"

          podman manifest create ${SHA_TAG}
          podman manifest create ${LATEST_TAG}

          podman build --platform linux/amd64 --build-arg TARGETARCH=amd64 --manifest ${SHA_TAG} ./services/media-processor-service
          podman build --platform linux/arm64 --build-arg TARGETARCH=arm64 --manifest ${SHA_TAG} ./services/media-processor-service

          podman build --platform linux/amd64 --build-arg TARGETARCH=amd64 --manifest ${LATEST_TAG} ./services/media-processor-service
          podman build --platform linux/arm64 --build-arg TARGETARCH=arm64 --manifest ${LATEST_TAG} ./services/media-processor-service

          podman manifest push --remove-signatures ${SHA_TAG}
          podman manifest push --remove-signatures ${LATEST_TAG}

  # Build settings service
  build-settings-service:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      (needs.detect-changes.outputs.settings == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && (inputs.build-all || contains(inputs.services, 'settings')))
    environment:
      name: prod
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install Podman and QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y podman qemu-user-static

      - name: Setup QEMU for multi-arch builds
        run: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Build and push multi-arch image
        run: |
          IMAGE_PATH="${{ env.REGISTRY }}/pierrestephanevoltaire/${{ env.IMAGE_PREFIX }}/settings-service"
          SHA_TAG="${IMAGE_PATH}:${GITHUB_SHA::8}"
          LATEST_TAG="${IMAGE_PATH}:latest"

          podman manifest create ${SHA_TAG}
          podman manifest create ${LATEST_TAG}

          podman build --platform linux/amd64 --build-arg TARGETARCH=amd64 --manifest ${SHA_TAG} ./services/settings-service
          podman build --platform linux/arm64 --build-arg TARGETARCH=arm64 --manifest ${SHA_TAG} ./services/settings-service

          podman build --platform linux/amd64 --build-arg TARGETARCH=amd64 --manifest ${LATEST_TAG} ./services/settings-service
          podman build --platform linux/arm64 --build-arg TARGETARCH=arm64 --manifest ${LATEST_TAG} ./services/settings-service

          podman manifest push --remove-signatures ${SHA_TAG}
          podman manifest push --remove-signatures ${LATEST_TAG}

  # Build program service
  build-program-service:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      (needs.detect-changes.outputs.program == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && (inputs.build-all || contains(inputs.services, 'program')))
    environment:
      name: prod
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install Podman and QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y podman qemu-user-static

      - name: Setup QEMU for multi-arch builds
        run: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Build and push multi-arch image
        run: |
          IMAGE_PATH="${{ env.REGISTRY }}/pierrestephanevoltaire/${{ env.IMAGE_PREFIX }}/program-service"
          SHA_TAG="${IMAGE_PATH}:${GITHUB_SHA::8}"
          LATEST_TAG="${IMAGE_PATH}:latest"

          podman manifest create ${SHA_TAG}
          podman manifest create ${LATEST_TAG}

          podman build --platform linux/amd64 --build-arg TARGETARCH=amd64 --manifest ${SHA_TAG} ./services/program-service
          podman build --platform linux/arm64 --build-arg TARGETARCH=arm64 --manifest ${SHA_TAG} ./services/program-service

          podman build --platform linux/amd64 --build-arg TARGETARCH=amd64 --manifest ${LATEST_TAG} ./services/program-service
          podman build --platform linux/arm64 --build-arg TARGETARCH=arm64 --manifest ${LATEST_TAG} ./services/program-service

          podman manifest push --remove-signatures ${SHA_TAG}
          podman manifest push --remove-signatures ${LATEST_TAG}

  # Build coach service
  build-coach-service:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      (needs.detect-changes.outputs.coach == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && (inputs.build-all || contains(inputs.services, 'coach')))
    environment:
      name: prod
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install Podman and QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y podman qemu-user-static

      - name: Setup QEMU for multi-arch builds
        run: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Build and push multi-arch image
        run: |
          IMAGE_PATH="${{ env.REGISTRY }}/pierrestephanevoltaire/${{ env.IMAGE_PREFIX }}/coach-service"
          SHA_TAG="${IMAGE_PATH}:${GITHUB_SHA::8}"
          LATEST_TAG="${IMAGE_PATH}:latest"

          podman manifest create ${SHA_TAG}
          podman manifest create ${LATEST_TAG}

          podman build --platform linux/amd64 --build-arg TARGETARCH=amd64 --manifest ${SHA_TAG} ./services/coach-service
          podman build --platform linux/arm64 --build-arg TARGETARCH=arm64 --manifest ${SHA_TAG} ./services/coach-service

          podman build --platform linux/amd64 --build-arg TARGETARCH=amd64 --manifest ${LATEST_TAG} ./services/coach-service
          podman build --platform linux/arm64 --build-arg TARGETARCH=arm64 --manifest ${LATEST_TAG} ./services/coach-service

          podman manifest push --remove-signatures ${SHA_TAG}
          podman manifest push --remove-signatures ${LATEST_TAG}

  # Build notification service
  build-notification-service:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      (needs.detect-changes.outputs.notification == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && (inputs.build-all || contains(inputs.services, 'notification')))
    environment:
      name: prod
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install Podman and QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y podman qemu-user-static

      - name: Setup QEMU for multi-arch builds
        run: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Build and push multi-arch image
        run: |
          IMAGE_PATH="${{ env.REGISTRY }}/pierrestephanevoltaire/${{ env.IMAGE_PREFIX }}/notification-service"
          SHA_TAG="${IMAGE_PATH}:${GITHUB_SHA::8}"
          LATEST_TAG="${IMAGE_PATH}:latest"

          podman manifest create ${SHA_TAG}
          podman manifest create ${LATEST_TAG}

          podman build --platform linux/amd64 --build-arg TARGETARCH=amd64 --manifest ${SHA_TAG} ./services/notification-service
          podman build --platform linux/arm64 --build-arg TARGETARCH=arm64 --manifest ${SHA_TAG} ./services/notification-service

          podman build --platform linux/amd64 --build-arg TARGETARCH=amd64 --manifest ${LATEST_TAG} ./services/notification-service
          podman build --platform linux/arm64 --build-arg TARGETARCH=arm64 --manifest ${LATEST_TAG} ./services/notification-service

          podman manifest push --remove-signatures ${SHA_TAG}
          podman manifest push --remove-signatures ${LATEST_TAG}

  # Build dm service
  build-dm-service:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      (needs.detect-changes.outputs.dm == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && (inputs.build-all || contains(inputs.services, 'dm')))
    environment:
      name: prod
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install Podman and QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y podman qemu-user-static

      - name: Setup QEMU for multi-arch builds
        run: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Build and push multi-arch image
        run: |
          IMAGE_PATH="${{ env.REGISTRY }}/pierrestephanevoltaire/${{ env.IMAGE_PREFIX }}/dm-service"
          SHA_TAG="${IMAGE_PATH}:${GITHUB_SHA::8}"
          LATEST_TAG="${IMAGE_PATH}:latest"

          podman manifest create ${SHA_TAG}
          podman manifest create ${LATEST_TAG}

          podman build --platform linux/amd64 --build-arg TARGETARCH=amd64 --manifest ${SHA_TAG} ./services/dm-service
          podman build --platform linux/arm64 --build-arg TARGETARCH=arm64 --manifest ${SHA_TAG} ./services/dm-service

          podman build --platform linux/amd64 --build-arg TARGETARCH=amd64 --manifest ${LATEST_TAG} ./services/dm-service
          podman build --platform linux/arm64 --build-arg TARGETARCH=arm64 --manifest ${LATEST_TAG} ./services/dm-service

          podman manifest push --remove-signatures ${SHA_TAG}
          podman manifest push --remove-signatures ${LATEST_TAG}

  # Build machine service
  build-machine-service:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      (needs.detect-changes.outputs.machine == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && (inputs.build-all || contains(inputs.services, 'machine')))
    environment:
      name: prod
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install Podman and QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y podman qemu-user-static

      - name: Setup QEMU for multi-arch builds
        run: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Build and push multi-arch image
        run: |
          IMAGE_PATH="${{ env.REGISTRY }}/pierrestephanevoltaire/${{ env.IMAGE_PREFIX }}/machine-service"
          SHA_TAG="${IMAGE_PATH}:${GITHUB_SHA::8}"
          LATEST_TAG="${IMAGE_PATH}:latest"

          podman manifest create ${SHA_TAG}
          podman manifest create ${LATEST_TAG}

          podman build --platform linux/amd64 --build-arg TARGETARCH=amd64 --manifest ${SHA_TAG} ./services/machine-service
          podman build --platform linux/arm64 --build-arg TARGETARCH=arm64 --manifest ${SHA_TAG} ./services/machine-service

          podman build --platform linux/amd64 --build-arg TARGETARCH=amd64 --manifest ${LATEST_TAG} ./services/machine-service
          podman build --platform linux/arm64 --build-arg TARGETARCH=arm64 --manifest ${LATEST_TAG} ./services/machine-service

          podman manifest push --remove-signatures ${SHA_TAG}
          podman manifest push --remove-signatures ${LATEST_TAG}

  # Build reminder service
  build-reminder-service:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      (needs.detect-changes.outputs.reminder == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && (inputs.build-all || contains(inputs.services, 'reminder')))
    environment:
      name: prod
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install Podman and QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y podman qemu-user-static

      - name: Setup QEMU for multi-arch builds
        run: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Build and push multi-arch image
        run: |
          IMAGE_PATH="${{ env.REGISTRY }}/pierrestephanevoltaire/${{ env.IMAGE_PREFIX }}/reminder-service"
          SHA_TAG="${IMAGE_PATH}:${GITHUB_SHA::8}"
          LATEST_TAG="${IMAGE_PATH}:latest"

          podman manifest create ${SHA_TAG}
          podman manifest create ${LATEST_TAG}

          podman build --platform linux/amd64 --build-arg TARGETARCH=amd64 --manifest ${SHA_TAG} ./services/reminder-service
          podman build --platform linux/arm64 --build-arg TARGETARCH=arm64 --manifest ${SHA_TAG} ./services/reminder-service

          podman build --platform linux/amd64 --build-arg TARGETARCH=amd64 --manifest ${LATEST_TAG} ./services/reminder-service
          podman build --platform linux/arm64 --build-arg TARGETARCH=arm64 --manifest ${LATEST_TAG} ./services/reminder-service

          podman manifest push --remove-signatures ${SHA_TAG}
          podman manifest push --remove-signatures ${LATEST_TAG}

  # Build frontend
  build-frontend:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      (needs.detect-changes.outputs.frontend == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && (inputs.build-all || contains(inputs.services, 'frontend')))
    environment:
      name: prod
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install Podman and QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y podman qemu-user-static

      - name: Setup QEMU for multi-arch builds
        run: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Build and push multi-arch image
        run: |
          IMAGE_PATH="${{ env.REGISTRY }}/pierrestephanevoltaire/${{ env.IMAGE_PREFIX }}/frontend"
          SHA_TAG="${IMAGE_PATH}:${GITHUB_SHA::8}"
          LATEST_TAG="${IMAGE_PATH}:latest"

          podman manifest create ${SHA_TAG}
          podman manifest create ${LATEST_TAG}

          podman build --platform linux/amd64 --build-arg TARGETARCH=amd64 --build-arg REACT_APP_API_URL=https://api.${{ vars.DOMAIN_NAME }} --manifest ${SHA_TAG} ./frontend
          podman build --platform linux/arm64 --build-arg TARGETARCH=arm64 --build-arg REACT_APP_API_URL=https://api.${{ vars.DOMAIN_NAME }} --manifest ${SHA_TAG} ./frontend

          podman build --platform linux/amd64 --build-arg TARGETARCH=amd64 --build-arg REACT_APP_API_URL=https://api.${{ vars.DOMAIN_NAME }} --manifest ${LATEST_TAG} ./frontend
          podman build --platform linux/arm64 --build-arg TARGETARCH=arm64 --build-arg REACT_APP_API_URL=https://api.${{ vars.DOMAIN_NAME }} --manifest ${LATEST_TAG} ./frontend

          podman manifest push --remove-signatures ${SHA_TAG}
          podman manifest push --remove-signatures ${LATEST_TAG}

  # Security scan for Docker images
  security-scan-images:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-auth-service, build-user-service, build-video-service, build-media-processor-service, build-settings-service, build-program-service, build-coach-service, build-notification-service, build-dm-service, build-machine-service, build-reminder-service, build-frontend]
    if: |
      always() &&
      (
        (github.event_name == 'push' && github.ref == 'refs/heads/main' &&
          (needs.detect-changes.outputs.auth == 'true' ||
           needs.detect-changes.outputs.user == 'true' ||
           needs.detect-changes.outputs.video == 'true' ||
           needs.detect-changes.outputs.media-processor == 'true' ||
           needs.detect-changes.outputs.settings == 'true' ||
           needs.detect-changes.outputs.program == 'true' ||
           needs.detect-changes.outputs.coach == 'true' ||
           needs.detect-changes.outputs.notification == 'true' ||
           needs.detect-changes.outputs.dm == 'true' ||
           needs.detect-changes.outputs.machine == 'true' ||
           needs.detect-changes.outputs.reminder == 'true' ||
           needs.detect-changes.outputs.frontend == 'true')
        ) ||
        (github.event_name == 'workflow_dispatch' &&
          (inputs.build-all || inputs.services != '')
        )
      )
    permissions:
      contents: read
      packages: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Scan images with Trivy
        run: |
          SERVICES=""

          # Build list of services to scan based on what was built
          if [ "${{ needs.detect-changes.outputs.auth }}" == "true" ]; then SERVICES="$SERVICES auth-service"; fi
          if [ "${{ needs.detect-changes.outputs.user }}" == "true" ]; then SERVICES="$SERVICES user-service"; fi
          if [ "${{ needs.detect-changes.outputs.video }}" == "true" ]; then SERVICES="$SERVICES video-service"; fi
          if [ "${{ needs.detect-changes.outputs.media-processor }}" == "true" ]; then SERVICES="$SERVICES media-processor-service"; fi
          if [ "${{ needs.detect-changes.outputs.settings }}" == "true" ]; then SERVICES="$SERVICES settings-service"; fi
          if [ "${{ needs.detect-changes.outputs.program }}" == "true" ]; then SERVICES="$SERVICES program-service"; fi
          if [ "${{ needs.detect-changes.outputs.coach }}" == "true" ]; then SERVICES="$SERVICES coach-service"; fi
          if [ "${{ needs.detect-changes.outputs.notification }}" == "true" ]; then SERVICES="$SERVICES notification-service"; fi
          if [ "${{ needs.detect-changes.outputs.dm }}" == "true" ]; then SERVICES="$SERVICES dm-service"; fi
          if [ "${{ needs.detect-changes.outputs.machine }}" == "true" ]; then SERVICES="$SERVICES machine-service"; fi
          if [ "${{ needs.detect-changes.outputs.reminder }}" == "true" ]; then SERVICES="$SERVICES reminder-service"; fi
          if [ "${{ needs.detect-changes.outputs.frontend }}" == "true" ]; then SERVICES="$SERVICES frontend"; fi

          echo "Scanning services: $SERVICES"

          for SERVICE in $SERVICES; do
            IMAGE="${{ env.REGISTRY }}/pierrestephanevoltaire/${{ env.IMAGE_PREFIX }}/${SERVICE}:${GITHUB_SHA::8}"
            echo "Scanning $IMAGE..."

            trivy image \
              --severity HIGH,CRITICAL \
              --format sarif \
              --output trivy-${SERVICE}.sarif \
              $IMAGE || echo "Warning: Scan failed for $SERVICE"

            # Also output to console for immediate visibility
            trivy image \
              --severity HIGH,CRITICAL \
              $IMAGE || echo "Warning: Scan failed for $SERVICE"
          done

      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: '.'
          category: 'container-security'
        continue-on-error: true

  # Security scan for infrastructure
  security-scan-infrastructure:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.infrastructure == 'true' || github.event_name == 'push' || github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          soft_fail: true
          working_directory: infrastructure
          format: sarif
          additional_args: --out tfsec-results.sarif

      - name: Upload tfsec results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: tfsec-results.sarif
          category: 'infrastructure-security'
        continue-on-error: true

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: infrastructure
          framework: terraform
          output_format: sarif
          output_file_path: checkov-results.sarif
          soft_fail: true

      - name: Upload Checkov results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: checkov-results.sarif
          category: 'infrastructure-security-checkov'
        continue-on-error: true
