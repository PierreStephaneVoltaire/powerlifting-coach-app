name: PR Validation

on:
  pull_request:
    branches: [ main, develop ]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: "powerlifting-coach"

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      infrastructure: ${{ steps.filter.outputs.infrastructure }}
      services: ${{ steps.filter.outputs.services }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'frontend/**'
            infrastructure:
              - 'infrastructure/**'
            services:
              - 'services/**'
              - 'shared/**'

  validate-terraform:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.infrastructure == 'true'
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"

      - name: Terraform fmt check
        run: terraform fmt -check -recursive
        working-directory: infrastructure
        continue-on-error: true

      - name: Terraform init
        run: terraform init -backend=false
        working-directory: infrastructure

      - name: Terraform validate
        run: terraform validate
        working-directory: infrastructure

  build-frontend:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Build frontend image
        run: |
          podman build -t frontend:pr-${{ github.event.pull_request.number }} ./frontend

  build-services:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.services == 'true'
    strategy:
      matrix:
        service:
          - auth-service
          - user-service
          - video-service
          - media-processor-service
          - settings-service
          - program-service
          - coach-service
          - notification-service
          - dm-service
          - machine-service
          - reminder-service
    steps:
      - uses: actions/checkout@v4

      - name: Check if service changed
        id: check
        run: |
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "services/${{ matrix.service }}/\|shared/"; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Podman
        if: steps.check.outputs.changed == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Build service image
        if: steps.check.outputs.changed == 'true'
        run: |
          podman build -t ${{ matrix.service }}:pr-${{ github.event.pull_request.number }} ./services/${{ matrix.service }}
